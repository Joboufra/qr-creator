name: Deploy QR Creator

on:
  push:
    branches:
      - main
      - dev
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  backend:
    name: Backend (FastAPI)
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Instalar dependencias backend
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Escribir .env backend
        run: |
          cat <<'EOF' > .env
          QR_API_KEY=${{ secrets.QR_API_KEY }}
          QR_RATE_LIMIT=${{ vars.QR_RATE_LIMIT || '60' }}
          QR_RATE_WINDOW=${{ vars.QR_RATE_WINDOW || '60' }}
          NEXT_PUBLIC_API_BASE=${{ vars.NEXT_PUBLIC_API_BASE }}
          EOF

      - name: Smoke check backend
        run: |
          source .venv/bin/activate
          python - <<'PY'
          from app.main import app
          print("Loaded routes:", len(list(app.router.routes)))
          PY

      - name: Disparar deploy backend
        env:
          BACKEND_DEPLOY_FLAG_PATH: ${{ vars.BACKEND_DEPLOY_FLAG_PATH }}
        run: |
          if [ -z "$BACKEND_DEPLOY_FLAG_PATH" ]; then
            echo "Falta definir vars.BACKEND_DEPLOY_FLAG_PATH" >&2
            exit 1
          fi
          touch "$BACKEND_DEPLOY_FLAG_PATH"

  frontend:
    name: Frontend (Next.js)
    if: github.ref == 'refs/heads/dev' || github.event_name == 'workflow_dispatch'
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Usar Node.js 24.12.x
        uses: actions/setup-node@v4
        with:
          node-version: "24.12.x"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Ejecutar npm ci
        working-directory: frontend
        run: npm ci

      - name: Hacer build frontend
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_BASE: ${{ vars.NEXT_PUBLIC_API_BASE }}
          NEXT_PUBLIC_API_KEY: ${{ secrets.NEXT_PUBLIC_API_KEY }}
        run: npm run build --if-present

      - name: Volver a desplegar frontend
        env:
          FRONTEND_PM2_APP: ${{ vars.FRONTEND_PM2_APP }}
        run: |
          if [ -z "$FRONTEND_PM2_APP" ]; then
            echo "Falta definir vars.FRONTEND_PM2_APP" >&2
            exit 1
          fi
          pm2 reload "$FRONTEND_PM2_APP"
