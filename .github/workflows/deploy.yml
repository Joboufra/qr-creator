name: Deploy QR Creator

on:
  push:
    branches:
      - main
      - dev
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  backend:
    name: Backend (FastAPI)
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Instalar dependencias backend
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Escribir .env backend
        run: |
          cat <<'EOF' > .env
          QR_API_KEY=${{ secrets.QR_API_KEY }}
          QR_RATE_LIMIT=${{ vars.QR_RATE_LIMIT || '60' }}
          QR_RATE_WINDOW=${{ vars.QR_RATE_WINDOW || '60' }}
          NEXT_PUBLIC_API_BASE=${{ secrets.NEXT_PUBLIC_API_BASE }}
          UVICORN_HOST=${{ secrets.UVICORN_HOST || '0.0.0.0' }}
          UVICORN_PORT=${{ secrets.UVICORN_PORT || '8000' }}
          UVICORN_WORKERS=${{ vars.UVICORN_WORKERS || '2' }}
          EOF

      - name: Smoke check backend
        run: |
          source .venv/bin/activate
          python - <<'PY'
          from app.main import app
          print("Loaded routes:", len(list(app.router.routes)))
          PY

      - name: Sincronizar workspace a deploy
        env:
          DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}
        run: |
          if [ -z "$DEPLOY_DIR" ]; then
            echo "Falta definir secrets.DEPLOY_DIR" >&2
            exit 1
          fi
          mkdir -p "$DEPLOY_DIR"
          rsync -avh --delete \
            --exclude '.venv/' \
            "$GITHUB_WORKSPACE"/ "$DEPLOY_DIR"/

      - name: Instalar deps en deploy (backend)
        env:
          DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}
        run: |
          if [ -z "$DEPLOY_DIR" ]; then
            echo "Falta definir secrets.DEPLOY_DIR" >&2
            exit 1
          fi
          cd "$DEPLOY_DIR"
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Disparar deploy backend (uvicorn/service)
        env:
          DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}
          BACKEND_DEPLOY_FLAG_PATH: ${{ secrets.BACKEND_DEPLOY_FLAG_PATH }}
        run: |
          if [ -z "$DEPLOY_DIR" ]; then
            echo "Falta definir secrets.DEPLOY_DIR" >&2
            exit 1
          fi
          if [ -z "$BACKEND_DEPLOY_FLAG_PATH" ]; then
            echo "Falta definir secrets.BACKEND_DEPLOY_FLAG_PATH" >&2
            exit 1
          fi
          # SeÃ±al externa para reiniciar el servicio uvicorn (systemd/supervisor/inotify)
          touch "$BACKEND_DEPLOY_FLAG_PATH"

  frontend:
    name: Frontend (Next.js)
    needs: backend
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Usar Node.js 24.12.x
        uses: actions/setup-node@v4
        with:
          node-version: "24.12.x"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Ejecutar npm ci
        working-directory: frontend
        run: npm ci

      - name: Hacer build frontend
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_BASE: ${{ secrets.NEXT_PUBLIC_API_BASE }}
          NEXT_PUBLIC_API_KEY: ${{ secrets.NEXT_PUBLIC_API_KEY }}
        run: npm run build --if-present

      - name: Sincronizar workspace a deploy
        env:
          DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}
        run: |
          if [ -z "$DEPLOY_DIR" ]; then
            echo "Falta definir secrets.DEPLOY_DIR" >&2
            exit 1
          fi
          mkdir -p "$DEPLOY_DIR"
          rsync -avh --delete \
            --exclude '.venv/' \
            "$GITHUB_WORKSPACE"/ "$DEPLOY_DIR"/

      - name: Escribir .env.frontend para pm2
        env:
          DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}
          FRONTEND_PORT: ${{ vars.FRONTEND_PORT || '4000' }}
        run: |
          if [ -z "$DEPLOY_DIR" ]; then
            echo "Falta definir secrets.DEPLOY_DIR" >&2
            exit 1
          fi
          mkdir -p "$DEPLOY_DIR"
          echo "PORT=${FRONTEND_PORT}" > "$DEPLOY_DIR/.env.frontend"

      - name: Volver a desplegar frontend
        env:
          FRONTEND_PM2_APP: ${{ secrets.FRONTEND_PM2_APP }}
          DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}
        run: |
          if [ -z "$FRONTEND_PM2_APP" ]; then
            echo "Falta definir secrets.FRONTEND_PM2_APP" >&2
            exit 1
          fi
          if [ -z "$DEPLOY_DIR" ]; then
            echo "Falta definir secrets.DEPLOY_DIR" >&2
            exit 1
          fi
          cd "$DEPLOY_DIR"
          pm2 reload "$FRONTEND_PM2_APP" --update-env
